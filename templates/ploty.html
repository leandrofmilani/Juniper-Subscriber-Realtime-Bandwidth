{% extends "layout.html" %}
{% block content %}
<div id="info" style="display: none;">
    <div class="card-deck">
        <div class="card text-white bg-secondary" >
            <div class="card-header"><i class="fas fa-user fa-lg"></i> PPPoE</div>
            <div class="card-body">
                <p id="pppoe" class="card-text">/p>
            </div>
            <div class="card-footer">
                <small id="ipaddress"></small>
            </div>
        </div>
        <div class="card text-white bg-danger" >
            <div class="card-header"><i class="fas fa-download fa-lg"></i> Download</div>
            <div class="card-body">
                <h4 id="download" class="card-text"></h4>
            </div>
            <div class="card-footer">
                <small id="filterout"></small>
            </div>
        </div>
        <div class="card text-white bg-primary" >
            <div class="card-header"><i class="fas fa-upload fa-lg"></i> Upload</div>
            <div class="card-body">
                <h4 id="upload" class="card-text"></h4>
            </div>
            <div class="card-footer">
                <small id="filterin"></small>
            </div>
        </div>
    </div>
</div>
<div id="loading">
    <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
</div>
<div id="alert" class="alert alert-danger" style="display: none;"></div>
<div id="chart" style="height: 250px; width: 100%;"></div>
<div id="pause" class="custom-control custom-switch" style="display: none;">
    <input value="Pause" type="checkbox" class="custom-control-input" id="pause_continue" onclick="pause_continue();">
    <label class="custom-control-label" for="pause_continue">Pause</label>
</div>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    if(typeof(EventSource) !== "undefined") {

        var up = 0;
        var down = 0;
        var time = new Date();
        var pause = false;
        var showData = true;
        var cnt = 0;

        var source = new EventSource("/data");
        source.onmessage = function(event) {
            console.log(event.data);
            var data = JSON.parse(event.data);
            document.getElementById("loading").style.display = 'none';

            if (data['error']){
                var msg = data['error'];
                source.close();
                console.log(msg);
                document.getElementById("alert").style.display = 'block';
                document.getElementById("alert").innerHTML = msg;
            }else{
                if (showData){
                    var username = data["username"];
                    var filterin = data["filterin"];
                    var filterout = data["filterout"];
                    var ipaddress = data["ipaddress"];
                    document.getElementById("pppoe").innerHTML = username;
                    document.getElementById("ipaddress").innerHTML = ipaddress;
                    document.getElementById("filterin").innerHTML = filterin;
                    document.getElementById("filterout").innerHTML = filterout;
                    Plotly.plot('chart', toPlot, layout,{responsive: true, displayModeBar: false});
                    document.getElementById("info").style.display = 'block';
                    showData = false;
                    console.log('Rendered chart!');
                }
                up = data["up"];
                down = data["down"];
                document.getElementById("download").innerHTML = getSpeed(down);
                document.getElementById("upload").innerHTML = getSpeed(up);
                updateChart();
            }						
        }

        function roundToTwo(num) {    
            return +(Math.round(num + "e+2")  + "e-2");
        }

        function getSpeed(speed) {
            if (speed >= 1024){
                var value_mbps = (speed / 1024);
                var mbps = roundToTwo(value_mbps);
                var data = `${mbps} Mbps`;
                return data;
            }else{
                var data = `${speed} Kbps`;
                return data;
            }
        }

        function pause_continue(){
            var currentvalue = document.getElementById('pause_continue').value;
            if(currentvalue == 'Continue'){
                document.getElementById('pause_continue').value='Pause';
                pause = false;
            }else{
                document.getElementById('pause_continue').value='Continue';
                pause = true;
            }
        }
        
        var upload = {
            x: [time],
            y: [up],
            hovertemplate: '%{y} kbps',
            name: "Upload",
            mode: 'line'
        };

        var download = {
            x: [time],
            y: [down],
            hovertemplate: '%{y} kbps',
            line: {
                color: 'rgb(255,0,0)'
            },
            name: "Download",
            mode: 'line'
        };

        var toPlot = [upload,download];

        var layout = {
            showlegend: false,
            plot_bgcolor: '#303030',
            paper_bgcolor: '#333',
            gridcolor: '#fff',
            margin: {
                l: 50,
                r: 50,
                t: 5,
                b: 25,
            },
            xaxis: {
                tickformat: '%H:%M:%S',
                tickfont: {color: '#fff'}
            },
            yaxis: {
                title: 'Kbps',
                rangemode: 'tozero',
                titlefont: {color: '#fff'},
                tickfont: {color: '#fff'}
            }
        };
        
        function updateChart() {
            var time = new Date();
            Plotly.extendTraces('chart', {
                x: [[time], [time]],
                y: [[up], [down]]
            }, [0, 1])
            cnt++;
            if(cnt >= 30 && pause == false) {
                document.getElementById("pause").style.display = 'block';
                Plotly.relayout('chart',{
                    xaxis: {
                        range: [time.getTime()-(60*1000),time.getTime()+(2*1000)],
                        tickformat: '%H:%M:%S',
                        tickfont: {color: '#fff'}
                    }
                });
            }
        }

    }else{
        alert('Sorry! No server-sent events support in this browser...');
    }
</script>
{% endblock content %}